# Requirement Clarification Service - æ™ºèƒ½éœ€æ±‚æ¾„æ¸…æœåŠ¡
#
# === æ ¸å¿ƒæ”¹è¿›åŠŸèƒ½ ===
# æœ¬æ¨¡å—æ˜¯é¡¹ç›®çš„é‡è¦åˆ›æ–°ä¹‹ä¸€ï¼Œæä¾›æ™ºèƒ½éœ€æ±‚æ¾„æ¸…èƒ½åŠ›
#
# ğŸ¯ åŠŸèƒ½ä»·å€¼:
# - å°†ç”¨æˆ·çš„æ¨¡ç³Šæƒ³æ³•è½¬åŒ–ä¸ºæ¸…æ™°ã€å…·ä½“çš„éœ€æ±‚åˆ—è¡¨
# - è¯†åˆ«å¹¶æ¾„æ¸…æ¨¡ç³Šæ¦‚å¿µå’Œä¸»è§‚è¯æ±‡
# - æ˜ç¡®åŠŸèƒ½è¾¹ç•Œã€æ€§èƒ½æŒ‡æ ‡å’ŒéªŒæ”¶æ ‡å‡†
# - ä¸“æ³¨äº"åšä»€ä¹ˆ"è€Œé"æ€ä¹ˆåš"ï¼Œé¿å…è¿‡æ—©çš„æ–¹æ¡ˆè®¾è®¡
#
# ğŸ”’ å®‰å…¨æ€§æ”¹è¿›:
# - å®Œå…¨ç§»é™¤ç¡¬ç¼–ç  API å¯†é’¥
# - é€šè¿‡ç¯å¢ƒå˜é‡å®‰å…¨ç®¡ç†æ•æ„Ÿä¿¡æ¯
# - å®Œå–„çš„é”™è¯¯å¤„ç†å’Œç”¨æˆ·å‹å¥½çš„æç¤º
#
# âš¡ æŠ€æœ¯ç‰¹æ€§:
# - æ”¯æŒæµå¼å’Œéæµå¼ä¸¤ç§å¤„ç†æ¨¡å¼
# - é›†æˆ Google Gemini 2.5 Flash æœ€æ–°æ¨¡å‹
# - æ™ºèƒ½ä¸Šä¸‹æ–‡å¤„ç†å’Œæ¨¡æ¿åŒ–è¾“å‡º
# - å¼‚æ­¥å¤„ç†æ”¯æŒï¼Œæå‡ç”¨æˆ·ä½“éªŒ

import os
import logging

try:
    from google import genai
    from google.genai import types
except ImportError:
    genai = None
    types = None

# Configure logging
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

# === éœ€æ±‚æ¾„æ¸…æ¨¡æ¿ ===
# è¿™æ˜¯æœ¬é¡¹ç›®çš„æ ¸å¿ƒåˆ›æ–°ä¹‹ä¸€ï¼Œä¸“æ³¨äºå°†ç”¨æˆ·çš„æ¨¡ç³Šæƒ³æ³•è½¬åŒ–ä¸ºæ¸…æ™°çš„éœ€æ±‚åˆ—è¡¨
# ä¸è¿›è¡Œæ–¹æ¡ˆè®¾è®¡ï¼Œåªè¿›è¡Œéœ€æ±‚æ¾„æ¸…å’Œå…·ä½“åŒ–
REQUIREMENT_CLARIFICATION_TEMPLATE = """# è§’è‰²
ä½ æ˜¯ä¸€ä¸ªé¡¶çº§çš„AIéœ€æ±‚åˆ†æä¸“å®¶ï¼Œæå…¶æ“…é•¿è¯†åˆ«ç”¨æˆ·è¡¨è¾¾ä¸­çš„æ¨¡ç³Šã€ä¸ç¡®åˆ‡ä¹‹å¤„ã€‚

# ä»»åŠ¡
ä½ çš„å”¯ä¸€ä»»åŠ¡æ˜¯å¯¹ç”¨æˆ·æä¾›çš„"åŸå§‹æ„å›¾"è¿›è¡Œéœ€æ±‚æ¾„æ¸…å’Œå…·ä½“åŒ–ï¼Œè€Œä¸æ˜¯è¿›è¡Œæ–¹æ¡ˆè®¾è®¡æˆ–æä¾›è§£å†³æ–¹æ¡ˆã€‚ä½ éœ€è¦å°†æ¨¡ç³Šçš„æè¿°è½¬åŒ–ä¸ºä¸€ç³»åˆ—æ¸…æ™°ã€å¯è¡¡é‡ã€å¯æ‰§è¡Œçš„å…·ä½“éœ€æ±‚ç‚¹ã€‚

# è¾“å‡ºè§„åˆ™
1. **ç¦æ­¢æ–¹æ¡ˆè®¾è®¡**ï¼šä¸è¦æå‡ºå®ç°æ–¹å¼ã€æŠ€æœ¯é€‰å‹æˆ–å…·ä½“çš„æ‰§è¡Œæ­¥éª¤ã€‚åªå…³æ³¨"åšä»€ä¹ˆ"ï¼Œä¸å…³æ³¨"æ€ä¹ˆåš"ã€‚
2. **ç¦æ­¢å¼•å¯¼è¯­**ï¼šç›´æ¥è¾“å‡ºæœ€ç»ˆæ¾„æ¸…å†…å®¹ï¼Œä¸è¦æ·»åŠ ä»»ä½•å¦‚"å¥½çš„ï¼Œè¿™æ˜¯ä¸ºæ‚¨æ¾„æ¸…åçš„éœ€æ±‚ï¼š"ä¹‹ç±»çš„å¼€åœºç™½æˆ–è§£é‡Šã€‚
3. **ä¸¥æ ¼éµå¾ªæ ¼å¼**ï¼šè¾“å‡ºå¿…é¡»ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹ç»“æ„ï¼š
   * ç¬¬ä¸€è¡Œä¸º"**æ˜ç¡®æ ¸å¿ƒä»»åŠ¡ï¼š**"åè·Ÿä¸€å¥è¯æ€»ç»“çš„æ ¸å¿ƒç›®æ ‡ã€‚
   * å…¶åä¸º"**æ¾„æ¸…éœ€æ±‚åˆ—è¡¨ï¼š**"æ ‡é¢˜ï¼Œä¸‹é¢æ˜¯å…·ä½“çš„æ¾„æ¸…éœ€æ±‚ç‚¹åˆ—è¡¨ã€‚

# æ¾„æ¸…é‡ç‚¹
- è¯†åˆ«æ¨¡ç³Šæ¦‚å¿µå¹¶ç›´æ¥æä¾›å…·ä½“å®šä¹‰å»ºè®®ï¼ˆå¦‚"å¥½ç”¨"ã€"å¿«é€Ÿ"ã€"å‡†ç¡®"ç­‰ä¸»è§‚è¯æ±‡ï¼‰
- æ˜ç¡®åŠŸèƒ½è¾¹ç•Œå’ŒèŒƒå›´é™åˆ¶çš„å…·ä½“é€‰é¡¹
- é‡åŒ–æ€§èƒ½æŒ‡æ ‡å’Œè¯„ä¼°æ ‡å‡†çš„å…·ä½“æ•°å€¼å»ºè®®
- ç¡®å®šè¾“å…¥è¾“å‡ºæ ¼å¼å’Œæ•°æ®ç±»å‹çš„å…·ä½“é€‰é¡¹
- æ¾„æ¸…ç”¨æˆ·ç¾¤ä½“å’Œä½¿ç”¨åœºæ™¯çš„å…·ä½“æè¿°
- è¯†åˆ«æ½œåœ¨çš„çº¦æŸæ¡ä»¶å’Œé™åˆ¶å› ç´ çš„å…·ä½“å†…å®¹
- æ˜ç¡®éªŒæ”¶æ ‡å‡†å’ŒæˆåŠŸæŒ‡æ ‡çš„å…·ä½“æ ‡å‡†

# é‡è¦æé†’
ä½ ä¸æ˜¯åœ¨è®©ç”¨æˆ·å¡«ç©ºæˆ–æ€è€ƒï¼Œè€Œæ˜¯ç›´æ¥ä¸ºç”¨æˆ·è¡¥å…¨å’Œæ¾„æ¸…éœ€æ±‚ã€‚æ¯ä¸ªæ¾„æ¸…ç‚¹éƒ½åº”è¯¥åŒ…å«å…·ä½“çš„å»ºè®®é€‰é¡¹å’Œç¤ºä¾‹ï¼Œè®©ç”¨æˆ·å¯ä»¥ç›´æ¥é€‰æ‹©æˆ–å‚è€ƒã€‚

# è¾“å‡ºç¤ºä¾‹
ä»¥ä¸‹æ˜¯ä¸€ä¸ªæ ‡å‡†çš„éœ€æ±‚æ¾„æ¸…ç¤ºä¾‹ï¼š

**è¾“å…¥ï¼š** "æˆ‘æƒ³è¦ä¸€ä¸ªèƒ½æ€»ç»“é•¿ç¯‡æ–‡ç« çš„å·¥å…·ï¼Œè¦åšå¾—å¥½ç”¨ã€å¿«é€Ÿã€å‡†ç¡®ã€‚"

**è¾“å‡ºï¼š**
å¼€å‘ä¸€ä¸ªèƒ½å¤Ÿè¾“å…¥é•¿ç¯‡æ–‡ç« å¹¶ç”Ÿæˆå…¶æ ¸å¿ƒå†…å®¹æ‘˜è¦çš„AIå·¥å…·ã€‚
- å®šä¹‰"é•¿ç¯‡æ–‡ç« "çš„å…·ä½“æ ‡å‡†ï¼ˆå»ºè®®é€‰é¡¹ï¼š500-2000å­—çŸ­æ–‡ã€2000-5000å­—ä¸­æ–‡ã€5000å­—ä»¥ä¸Šé•¿æ–‡ï¼›æ”¯æŒæ ¼å¼ï¼šçº¯æ–‡æœ¬ã€PDFã€Wordæ–‡æ¡£ã€ç½‘é¡µé“¾æ¥ï¼‰
- æ˜ç¡®æ‘˜è¦çš„è¾“å‡ºæ ¼å¼ï¼ˆå»ºè®®é€‰é¡¹ï¼šä¸€æ®µå¼æ‘˜è¦100-200å­—ã€å…³é”®ç‚¹åˆ—è¡¨å¼æ‘˜è¦3-5æ¡ã€å¯è‡ªå®šä¹‰é•¿åº¦çš„æ‘˜è¦ï¼‰
- é˜è¿°"å¥½ç”¨"çš„ç”¨æˆ·ä½“éªŒæ ‡å‡†ï¼ˆå»ºè®®é€‰é¡¹ï¼šç®€æ´çš„Webç•Œé¢ã€æ”¯æŒAPIè°ƒç”¨ã€ä¸€é”®å®Œæˆæ“ä½œã€æ‰¹é‡å¤„ç†åŠŸèƒ½ï¼›ç›®æ ‡ç”¨æˆ·ï¼šå­¦ç”Ÿã€ç ”ç©¶äººå‘˜ã€å†…å®¹åˆ›ä½œè€…ï¼‰
- é‡åŒ–"å¿«é€Ÿ"çš„æ€§èƒ½æŒ‡æ ‡ï¼ˆå»ºè®®æ ‡å‡†ï¼š5000å­—æ–‡ç« åœ¨3ç§’å†…å®Œæˆã€æ”¯æŒå¹¶å‘å¤„ç†ã€å“åº”æ—¶é—´ä¸è¶…è¿‡5ç§’ï¼‰
- è®¾å®š"å‡†ç¡®"çš„è¯„ä¼°æ ‡å‡†ï¼ˆå»ºè®®æ ‡å‡†ï¼šä¿ç•™åŸæ–‡å…³é”®ä¿¡æ¯95%ä»¥ä¸Šã€åŒ…å«ä¸»è¦äººååœ°åã€ä¿æŒåŸæ–‡é€»è¾‘ç»“æ„ã€æ”¯æŒå¤šè¯­è¨€å‡†ç¡®æ€§éªŒè¯ï¼‰
- ç¡®å®šæ”¯æŒçš„è¾“å…¥è¯­è¨€èŒƒå›´ï¼ˆå»ºè®®é€‰é¡¹ï¼šä»…ä¸­æ–‡ã€ä»…è‹±æ–‡ã€ä¸­è‹±åŒè¯­ã€å¤šè¯­è¨€æ”¯æŒï¼‰
- ç•Œå®šå·¥å…·çš„æ ¸å¿ƒè¾¹ç•Œï¼ˆå»ºè®®åŠŸèƒ½ï¼šçº¯æ‘˜è¦åŠŸèƒ½ã€æ‘˜è¦+å…³é”®è¯æå–ã€æ‘˜è¦+é—®ç­”ã€æ‘˜è¦+æƒ…æ„Ÿåˆ†æï¼‰

# è¯·å¼€å§‹è¿›è¡Œéœ€æ±‚æ¾„æ¸…ï¼š
"""


def enhance_prompt_with_gemini(user_text: str, context_info: str = "") -> str:
    """
    æ™ºèƒ½éœ€æ±‚æ¾„æ¸…å‡½æ•° - æ ¸å¿ƒåŠŸèƒ½å®ç°

    === åŠŸèƒ½äº®ç‚¹ ===
    è¿™æ˜¯æœ¬é¡¹ç›®çš„é‡è¦åˆ›æ–°åŠŸèƒ½ï¼Œä¸“æ³¨äºéœ€æ±‚æ¾„æ¸…è€Œéæ–¹æ¡ˆè®¾è®¡:

    ğŸ¯ è§£å†³çš„é—®é¢˜:
    - ç”¨æˆ·æä¾›çš„éœ€æ±‚å¾€å¾€æ¨¡ç³Šä¸æ¸…
    - ç¼ºä¹æ˜ç¡®çš„åŠŸèƒ½è¾¹ç•Œå’ŒéªŒæ”¶æ ‡å‡†
    - AI éš¾ä»¥ç†è§£çœŸæ­£çš„æ„å›¾å’Œç›®æ ‡

    ğŸ’¡ æä¾›çš„ä»·å€¼:
    - è¯†åˆ«å¹¶æ¾„æ¸…æ¨¡ç³Šæ¦‚å¿µå’Œä¸»è§‚è¯æ±‡
    - æ˜ç¡®åŠŸèƒ½è¾¹ç•Œå’ŒèŒƒå›´é™åˆ¶
    - é‡åŒ–æ€§èƒ½æŒ‡æ ‡å’Œè¯„ä¼°æ ‡å‡†
    - ç¡®å®šè¾“å…¥è¾“å‡ºæ ¼å¼å’Œæ•°æ®ç±»å‹
    - æ¾„æ¸…ç”¨æˆ·ç¾¤ä½“å’Œä½¿ç”¨åœºæ™¯

    ğŸ”’ å®‰å…¨æ€§æ”¹è¿›:
    - ç§»é™¤ç¡¬ç¼–ç  API å¯†é’¥ï¼Œé€šè¿‡ç¯å¢ƒå˜é‡ç®¡ç†
    - å®Œå–„çš„é”™è¯¯å¤„ç†å’Œç”¨æˆ·å‹å¥½æç¤º
    - è¾“å…¥éªŒè¯å’Œå¼‚å¸¸å®‰å…¨å¤„ç†

    Args:
        user_text: ç”¨æˆ·è¾“å…¥çš„åŸå§‹æ–‡æœ¬æˆ–æƒ³æ³•
        context_info: é¡¹ç›®ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œå¸®åŠ© AI æ›´å¥½ç†è§£éœ€æ±‚

    Returns:
        str: æ¾„æ¸…åçš„éœ€æ±‚åˆ—è¡¨ï¼Œæˆ–é”™è¯¯ä¿¡æ¯

    Example:
        è¾“å…¥: "æˆ‘æƒ³è¦ä¸€ä¸ªèƒ½æ€»ç»“é•¿ç¯‡æ–‡ç« çš„å·¥å…·ï¼Œè¦åšå¾—å¥½ç”¨ã€å¿«é€Ÿã€å‡†ç¡®"
        è¾“å‡º: æ˜ç¡®æ ¸å¿ƒä»»åŠ¡å’Œè¯¦ç»†çš„éœ€æ±‚æ¾„æ¸…åˆ—è¡¨ï¼ŒåŒ…æ‹¬å¯¹"å¥½ç”¨"ã€"å¿«é€Ÿ"ã€"å‡†ç¡®"ç­‰æ¨¡ç³Šæ¦‚å¿µçš„å…·ä½“åŒ–è¦æ±‚
    """
    if not genai or not types:
        return "é”™è¯¯ï¼šGoogle Gen AI SDK æœªæ­£ç¡®å®‰è£…ã€‚è¯·è¿è¡Œ 'pip install google-genai' å®‰è£…ä¾èµ–ã€‚"

    # æ£€æŸ¥ API å¯†é’¥ - ä»…ä½¿ç”¨ç¯å¢ƒå˜é‡
    api_key = os.environ.get("GEMINI_API_KEY")
    if not api_key:
        return "é”™è¯¯ï¼šæœªæ‰¾åˆ° GEMINI_API_KEY ç¯å¢ƒå˜é‡ã€‚è¯·åœ¨ MCP é…ç½®ä¸­è®¾ç½®è¯¥ç¯å¢ƒå˜é‡ã€‚"

    if not user_text.strip():
        return "é”™è¯¯ï¼šè¯·è¾“å…¥éœ€è¦å¢å¼ºçš„æ–‡æœ¬å†…å®¹ã€‚"
    
    try:
        # åˆ›å»ºå®¢æˆ·ç«¯
        client = genai.Client(api_key=api_key)

        # æ„å»ºè¯·æ±‚å†…å®¹ - åŒ…å«ç”¨æˆ·æ–‡æœ¬å’Œä¸Šä¸‹æ–‡ä¿¡æ¯
        user_content = user_text
        if context_info and context_info.strip():
            user_content = f"**é¡¹ç›®ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼š**\n{context_info}\n\n**ç”¨æˆ·éœ€æ±‚ï¼š**\n{user_text}"

        contents = [
            types.Content(
                role="user",
                parts=[types.Part.from_text(text=user_content)]
            )
        ]

        # é…ç½®ç”Ÿæˆå‚æ•° - å°†éœ€æ±‚æ¾„æ¸…æ¨¡æ¿è®¾ç½®ä¸ºç³»ç»ŸæŒ‡ä»¤
        config = types.GenerateContentConfig(
            thinking_config=types.ThinkingConfig(
                thinking_budget=0,  # ç¦ç”¨æ€è€ƒï¼Œæå‡ååº”é€Ÿåº¦
            ),
            system_instruction=[
                types.Part.from_text(text=REQUIREMENT_CLARIFICATION_TEMPLATE)
            ],
            response_mime_type="text/plain",
            temperature=0.7
        )

        # è°ƒç”¨ API
        logger.info("æ­£åœ¨è°ƒç”¨ Gemini API è¿›è¡Œéœ€æ±‚æ¾„æ¸…...")
        response = client.models.generate_content(
            model="gemini-2.5-flash-preview-05-20",  # ä½¿ç”¨æœ€æ–°çš„é¢„è§ˆæ¨¡å‹
            contents=contents,
            config=config
        )

        # è·å–å“åº”æ–‡æœ¬
        clarified_text = response.text
        if clarified_text:
            logger.info("éœ€æ±‚æ¾„æ¸…å®Œæˆ")
            return clarified_text.strip()
        else:
            return "é”™è¯¯ï¼šAPI è¿”å›äº†ç©ºå“åº”ã€‚è¯·æ£€æŸ¥æ‚¨çš„è¾“å…¥æˆ–ç¨åé‡è¯•ã€‚"

    except Exception as e:
        error_msg = f"é”™è¯¯ï¼šè°ƒç”¨ Gemini API æ—¶å‘ç”Ÿå¼‚å¸¸ï¼š{str(e)}"
        logger.error(error_msg)
        return error_msg


def enhance_prompt_with_gemini_stream(user_text: str) -> str:
    """
    ä½¿ç”¨æµå¼æ–¹å¼è°ƒç”¨ Gemini API è¿›è¡Œéœ€æ±‚æ¾„æ¸…

    Args:
        user_text: ç”¨æˆ·è¾“å…¥çš„åŸå§‹æ–‡æœ¬

    Returns:
        æ¾„æ¸…åçš„éœ€æ±‚åˆ—è¡¨ï¼Œå¦‚æœå‡ºé”™åˆ™è¿”å›é”™è¯¯ä¿¡æ¯
    """
    if not genai or not types:
        return "é”™è¯¯ï¼šGoogle Gen AI SDK æœªæ­£ç¡®å®‰è£…ã€‚è¯·è¿è¡Œ 'pip install google-genai' å®‰è£…ä¾èµ–ã€‚"

    # æ£€æŸ¥ API å¯†é’¥ - ä»…ä½¿ç”¨ç¯å¢ƒå˜é‡
    api_key = os.environ.get("GEMINI_API_KEY")
    if not api_key:
        return "é”™è¯¯ï¼šæœªæ‰¾åˆ° GEMINI_API_KEY ç¯å¢ƒå˜é‡ã€‚è¯·åœ¨ MCP é…ç½®ä¸­è®¾ç½®è¯¥ç¯å¢ƒå˜é‡ã€‚"

    if not user_text.strip():
        return "é”™è¯¯ï¼šè¯·è¾“å…¥éœ€è¦å¢å¼ºçš„æ–‡æœ¬å†…å®¹ã€‚"
    
    try:
        # åˆ›å»ºå®¢æˆ·ç«¯
        client = genai.Client(api_key=api_key)

        # æ„å»ºè¯·æ±‚å†…å®¹ - ç›´æ¥å‘é€ç”¨æˆ·æ–‡æœ¬
        contents = [
            types.Content(
                role="user",
                parts=[types.Part.from_text(text=user_text)]
            )
        ]

        # é…ç½®ç”Ÿæˆå‚æ•° - å°†éœ€æ±‚æ¾„æ¸…æ¨¡æ¿è®¾ç½®ä¸ºç³»ç»ŸæŒ‡ä»¤
        config = types.GenerateContentConfig(
            thinking_config=types.ThinkingConfig(
                thinking_budget=0,  # ç¦ç”¨æ€è€ƒï¼Œæå‡ååº”é€Ÿåº¦
            ),
            system_instruction=[
                types.Part.from_text(text=REQUIREMENT_CLARIFICATION_TEMPLATE)
            ],
            response_mime_type="text/plain",
            temperature=0.7
        )

        # è°ƒç”¨æµå¼ API
        logger.info("æ­£åœ¨è°ƒç”¨ Gemini API è¿›è¡Œéœ€æ±‚æ¾„æ¸…ï¼ˆæµå¼ï¼‰...")
        clarified_text_parts = []

        for chunk in client.models.generate_content_stream(
            model="gemini-2.5-flash-preview-05-20",
            contents=contents,
            config=config
        ):
            if chunk.text:
                clarified_text_parts.append(chunk.text)

        # ç»„åˆæ‰€æœ‰æ–‡æœ¬å—
        clarified_text = "".join(clarified_text_parts)
        if clarified_text:
            logger.info("éœ€æ±‚æ¾„æ¸…å®Œæˆ")
            return clarified_text.strip()
        else:
            return "é”™è¯¯ï¼šAPI è¿”å›äº†ç©ºå“åº”ã€‚è¯·æ£€æŸ¥æ‚¨çš„è¾“å…¥æˆ–ç¨åé‡è¯•ã€‚"

    except Exception as e:
        error_msg = f"é”™è¯¯ï¼šè°ƒç”¨ Gemini API æ—¶å‘ç”Ÿå¼‚å¸¸ï¼š{str(e)}"
        logger.error(error_msg)
        return error_msg


def enhance_prompt_with_gemini_stream_generator(user_text: str, context_info: str = ""):
    """
    ä½¿ç”¨æµå¼æ–¹å¼è°ƒç”¨ Gemini API è¿›è¡Œéœ€æ±‚æ¾„æ¸…ï¼Œè¿”å›ç”Ÿæˆå™¨

    Args:
        user_text: ç”¨æˆ·è¾“å…¥çš„åŸå§‹æ–‡æœ¬
        context_info: ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼ˆå¯é€‰ï¼‰

    Yields:
        str: æ¾„æ¸…éœ€æ±‚çš„æ–‡æœ¬å—
    """
    if not genai or not types:
        yield "é”™è¯¯ï¼šGoogle Gen AI SDK æœªæ­£ç¡®å®‰è£…ã€‚è¯·è¿è¡Œ 'pip install google-genai' å®‰è£…ä¾èµ–ã€‚"
        return

    # æ£€æŸ¥ API å¯†é’¥ - ä»…ä½¿ç”¨ç¯å¢ƒå˜é‡
    api_key = os.environ.get("GEMINI_API_KEY")
    if not api_key:
        yield "é”™è¯¯ï¼šæœªæ‰¾åˆ° GEMINI_API_KEY ç¯å¢ƒå˜é‡ã€‚è¯·åœ¨ MCP é…ç½®ä¸­è®¾ç½®è¯¥ç¯å¢ƒå˜é‡ã€‚"
        return

    if not user_text.strip():
        yield "é”™è¯¯ï¼šè¯·è¾“å…¥éœ€è¦å¢å¼ºçš„æ–‡æœ¬å†…å®¹ã€‚"
        return

    try:
        # åˆ›å»ºå®¢æˆ·ç«¯
        client = genai.Client(api_key=api_key)

        # æ„å»ºè¯·æ±‚å†…å®¹ - åŒ…å«ç”¨æˆ·æ–‡æœ¬å’Œä¸Šä¸‹æ–‡ä¿¡æ¯
        user_content = user_text
        if context_info and context_info.strip():
            user_content = f"**é¡¹ç›®ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼š**\n{context_info}\n\n**ç”¨æˆ·éœ€æ±‚ï¼š**\n{user_text}"

        contents = [
            types.Content(
                role="user",
                parts=[types.Part.from_text(text=user_content)]
            )
        ]

        # é…ç½®ç”Ÿæˆå‚æ•° - å°†éœ€æ±‚æ¾„æ¸…æ¨¡æ¿è®¾ç½®ä¸ºç³»ç»ŸæŒ‡ä»¤
        config = types.GenerateContentConfig(
            thinking_config=types.ThinkingConfig(
                thinking_budget=0,  # ç¦ç”¨æ€è€ƒï¼Œæå‡ååº”é€Ÿåº¦
            ),
            system_instruction=[
                types.Part.from_text(text=REQUIREMENT_CLARIFICATION_TEMPLATE)
            ],
            response_mime_type="text/plain",
            temperature=0.7
        )

        # è°ƒç”¨æµå¼ API
        logger.info("æ­£åœ¨è°ƒç”¨ Gemini API è¿›è¡Œéœ€æ±‚æ¾„æ¸…ï¼ˆæµå¼ç”Ÿæˆå™¨ï¼‰...")

        for chunk in client.models.generate_content_stream(
            model="gemini-2.5-flash-preview-05-20",
            contents=contents,
            config=config
        ):
            if chunk.text:
                yield chunk.text

        logger.info("éœ€æ±‚æ¾„æ¸…å®Œæˆ")

    except Exception as e:
        error_msg = f"é”™è¯¯ï¼šè°ƒç”¨ Gemini API æ—¶å‘ç”Ÿå¼‚å¸¸ï¼š{str(e)}"
        logger.error(error_msg)
        yield error_msg
